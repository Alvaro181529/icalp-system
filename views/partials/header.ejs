<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css" /> -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <title>
    <%= title %>
  </title>
  <style>
    body {
      background: #ebeaea;
    }

    #nav1 {
      transition: transform 0.3s ease;
    }

    #nav2 {
      transition: transform 0.3s ease;
    }
  </style>
</head>

<body>

  <% if (user) { %>
    <div class="min-h-screen flex">
      <!-- Sidebar -->
      <aside class="bg-blue-900 text-white w-64 p-4 fixed top-0 left-0 bottom-0 z-20 overflow-y-auto">
        <nav>
          <h3 class="font-bold text-xl mb-4 border-b pb-2">Panel</h3>
          <div class="space-y-2">

            <!-- Colegiados Section -->
            <details class="group">
              <summary class="flex items-center px-4 py-2 text-gray-200 rounded hover:bg-blue-950 cursor-pointer">
                <i class="fas fa-users mr-2"></i>
                <span>Colegiados</span>
                <i class="fas fa-chevron-down ml-auto transform group-open:rotate-180 transition-transform"></i>
              </summary>
              <ul class="pl-8 mt-2 space-y-1">
                <li><a href="/colegiados" class="block px-4 py-2 hover:bg-blue-950 rounded">Listado de Colegiados</a>
                </li>
                <li><a href="/colegiado/dia" class="block px-4 py-2 hover:bg-blue-950 rounded">Colegiados al día</a>
                </li>
                <li><a href="/aportes-anulados" class="block px-4 py-2 hover:bg-blue-950 rounded">Anulación de
                    aportes</a></li>
              </ul>
            </details>

            <!-- Reportes Section -->
            <details class="group">
              <summary class="flex items-center px-4 py-2 text-gray-200 rounded hover:bg-blue-950 cursor-pointer">
                <i class="fas fa-chart-bar mr-2"></i>
                <span>Reportes</span>
                <i class="fas fa-chevron-down ml-auto transform group-open:rotate-180 transition-transform"></i>
              </summary>
              <ul class="pl-8 mt-2 space-y-1">
                <li><a href="/aportes" class="block px-4 py-2 hover:bg-blue-950 rounded">Reporte de Aportes</a></li>
                <li><a href="/aporte-cobrador" class="block px-4 py-2 hover:bg-blue-950 rounded">Reportes mensuales por
                    cobrador</a></li>
                <li><a href="/aporte-mensual" class="block px-4 py-2 hover:bg-blue-950 rounded">Reportes mensuales</a>
                </li>
              </ul>
            </details>

            <!-- Colegiados por Año Section -->
            <details class="group">
              <summary class="flex items-center px-4 py-2 text-gray-200 rounded hover:bg-blue-950 cursor-pointer">
                <i class="fas fa-calendar-alt mr-2"></i>
                <span>Colegiados por Año</span>
                <i class="fas fa-chevron-down ml-auto transform group-open:rotate-180 transition-transform"></i>
              </summary>
              <ul class="pl-8 mt-2 space-y-1">
                <li><a href="/colegiado/gestion" class="block px-4 py-2 hover:bg-blue-950 rounded">Lista de Colegiados
                    por Fecha de Inscripción</a></li>
                <li><a href="/colegiado/provicion" class="block px-4 py-2 hover:bg-blue-950 rounded">Colegiados por
                    Título en Provisión Nacional</a></li>
                <li><a href="/talonario" class="block px-4 py-2 hover:bg-blue-950 rounded">Reporte de Talonarios</a>
                </li>
              </ul>
            </details>

            <!-- Configuración Section -->
            <details class="group">
              <summary class="flex items-center px-4 py-2 text-gray-200 rounded hover:bg-blue-950 cursor-pointer">
                <i class="fas fa-cog mr-2"></i>
                <span>Configuración</span>
                <i class="fas fa-chevron-down ml-auto transform group-open:rotate-180 transition-transform"></i>
              </summary>
              <ul class="pl-8 mt-2 space-y-1">
                <li><a href="/usuarios" class="block px-4 py-2 hover:bg-blue-950 rounded">Registro de Usuarios</a></li>
                <li><a href="/cobradores" class="block px-4 py-2 hover:bg-blue-950 rounded">Usuarios Cobradores</a>
                </li>
                <li><a href="/slides" class="block px-4 py-2 hover:bg-blue-950 rounded">Imagenes de Slider</a></li>
                <li><a href="/blogs" class="block px-4 py-2 hover:bg-blue-950 rounded">Creación de Blogs</a></li>
                <li><a href="/historial" class="block px-4 py-2 hover:bg-blue-950 rounded">Historial de Cambios</a></li>
              </ul>
            </details>
            <details class="group">
              <summary class="flex items-center px-4 py-2 text-gray-200 rounded hover:bg-blue-950 cursor-pointer">
                <i class="fa fa-file-text mr-2  " aria-hidden="true"></i>
                <span>Creacion de paginas</span>
                <i class="fas fa-chevron-down ml-auto transform group-open:rotate-180 transition-transform"></i>
              </summary>
              <ul class="pl-8 mt-2 space-y-1">
                <li><a href="/menus" class="block px-4 py-2 hover:bg-blue-950 rounded">Creacion de menu</a></li>
                <li><a href="/opciones" class="block px-4 py-2 hover:bg-blue-950 rounded">Creacion de opciones</a></li>
                <li><a href="/contenidos" class="block px-4 py-2 hover:bg-blue-950 rounded">Contenidos</a>
                </li>
              </ul>
            </details>

            <button type="button" id="cerrar"
              class="text-white bg-transparent text-gray-200  rounded hover:bg-blue-950  px-4 py-2 text-center">
              <i class="fa fa-sign-out mr-1"></i>
              <span>Cerrar sesión
              </span>
            </button>
          </div>
        </nav>
      </aside>
      <main class="ml-64 w-full overflow-y-auto">
        <% } %>
          <nav id="nav1" class="bg-black">
            <div
              class=" flex flex-wrap justify-between items-center mx-auto container mx-auto px-8  p-4 transition-all z-20">
              <section class="grid">
                <a href="mailto:presidencia@icalp.org.bo"
                  class="text-sm text-gray-300 hover:underline">presidencia@icalp.org.bo</a>
                <a href="tel:+59122407713" class="text-sm text-gray-300 hover:underline">(591) - 22407713</a>
              </section>
              <section class="flex items-center text-white space-x-6 ">
                <a href="/" class="hover:text-gray-400 max-md:hidden">Inicio</a>
                <a href="#" class="hover:text-gray-400 max-md:hidden">Centro de concilicion</a>
                <a href="#" class="hover:text-gray-400 max-md:hidden">Convocatorias</a>
                <a href="#" class="hover:text-gray-400 max-md:hidden">Blog</a>
                <a href="#" class="hover:text-gray-400 max-md:hidden">Comunicados oficiales</a>
              </section>
              <section class="flex items-center rtl:space-x-reverse">
                <form id="search-form">
                  <!-- <input id="search" type="search" placeholder="Buscar por Matricula, Carnet, Nombre o apellido" /> -->
                  <input type="text" id="search"
                    class="bg-gray-50 border border-gray-300  text-sm rounded-lg block w-full p-2.5"
                    placeholder="Busqueda" required />
                  <button id="search-button" type="submit" hidden>Buscar</button>
                </form>
              </section>
            </div>
          </nav>
          <nav id="nav2"
            class="bg-blue-950 bg-opacity-50 backdrop-blur-sm  <%= user ? 'sticky top-0' : 'fixed' %> z-50 w-full transition-all">
            <div class="container mx-auto px-8 px-4 py-3 mx-auto text-white">
              <div class="flex items-center gap-4">
                <a href="https://flowbite.com" class="flex items-center space-x-3">
                  <img src="https://flowbite.com/docs/images/logo.svg" class="h-8" alt="Flowbite Logo" />
                  <span class="self-center text-2xl font-semibold whitespace-nowrap">Flowbite</span>
                </a>
                <ul id="lista" class="flex flex-row font-medium mt-0 space-x-8 text-sm ml-auto">
                </ul>

                <% if (user) { %>
                  <h2 class="text-white font-bold text-sm">
                    <%= user.correo %>
                  </h2>
                  <% } else { %>
                    <a href="/login">
                      <button type="button"
                        class="text-white bg-transparent border-2 border-white hover:text-black hover:bg-white active:ring active:ring-gray-300 font-medium rounded-3xl text-sm px-4 py-2 text-center">
                        Iniciar sesión
                      </button>
                    </a>
                    <% } %>
              </div>
            </div>
          </nav>
          <dialog id="dialog-search" class="px-6 py-4 max-w-md w-full max-h-screen rounded-xl items-center justify-start bg-white shadow-lg border border-gray-300">
           <div class="flex flex-col ">
             <div class="flex  justify-between w-full mb-4">
               <h3 class="text-2xl font-semibold text-gray-700">Resultados de Búsqueda</h3>
               <button id="cerrar-dialog" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                 <i class="fa-solid fa-xmark fa-2x"></i>
                </button>
              </div>
              
              <ul id="result-list" class="flex flex-col w-full overflow-auto max-h-96 space-y-4">
                <!-- Los resultados se insertarán aquí dinámicamente -->
              </ul>
            </div>
          </dialog>
          <script defer>
            const $ = (el) => document.querySelector(el);
            function toggleSidebar() {
              const sidebar = document.querySelector('aside');
              sidebar.classList.toggle('hidden');
            }
            // Obtener los elementos
            const nav1 = document.getElementById('nav1');
            const nav2 = document.getElementById('nav2');

            let lastScrollTop = 0;

            window.addEventListener('scroll', function () {
              const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
              if (currentScroll > lastScrollTop) {
                nav1.style.transform = 'translateY(0%)'; // Esconde el primer nav
                nav2.style.transform = 'translateY(-120%)'; // Mueve el segundo nav hacia abajo (fuera de vista)
              } else {
                nav1.style.transform = 'translateY(0)'; // Vuelve a mostrar el primer nav
                nav2.style.transform = 'translateY(0)'; // El segundo nav se queda en la parte superior
              }

              // Actualizar la última posición del scroll
              lastScrollTop = currentScroll >= 0 ? 0 : currentScroll; // Evita valores negativos
            });
            const cerrarButton = document.getElementById("cerrar");
            if (cerrarButton) {
              cerrarButton.addEventListener("click", () => {
                fetch("/logout", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                })
                  .then((response) => {
                    if (response.ok) {
                      window.location.href = "/"; // Redirige a la página principal o a la página de inicio de sesión
                    } else {
                      alert("Error al cerrar sesión");
                    }
                  })
                  .catch((error) => {
                    console.error("Error:", error);
                    alert("Ocurrió un error al intentar cerrar sesión");
                  });
              });
            }
            const FetchData = async () => {
              try {
                // Solicitar los datos del backend
                const result = await fetch('/view');
                const res = await result.json();
                // Obtener la lista donde se agregarán los elementos
                const lista = document.getElementById('lista');
                lista.innerHTML = '';  // Limpiar la lista antes de llenarla

                // Iterar sobre los datos recibidos
                res.forEach(item => {
                  // Crear el <li> para cada menú
                  const li = document.createElement('li');
                  // Crear el botón de menú
                  const buttonHTML = `
                    <button id="dropdownNavbarLink-${item.MenuId}" data-dropdown-toggle="${item.MenuId}" 
                           class="flex items-center justify-between w-full py-2 px-3 text-white text-sm rounded hover:bg-gray-200 md:hover:bg-transparent md:border-0 md:hover:text-gray-200  md:p-0 md:w-auto ">
                      ${item.MenuNameEnglish}
                      <svg class="w-2.5 h-2.5 ms-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                      </svg>
                    </button>
                  `;

                  const dropdownHTML = `
                    <div id="dropdownNavbar-${item.MenuId}" class="z-10 hidden text-sm bg-blue-950 bg-opacity-30 backdrop-blur-md divide-y divide-gray-100 rounded-lg shadow w-44 absolute mt-2">
                    <ul class="py-2 text-sm text-white " aria-labelledby="dropdownLargeButton">
                      ${item.pages.map(page => `
                        <li>
                          <a href="/view/${item.MenuNameEnglish}/${page.PageTitle}" class="block px-4 py-2 hover:bg-blue-700 hover:bg-opacity-30 hover:backdrop-blur-sm ">
                            ${page.PageTitle}
                          </a>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                  `;
                  li.innerHTML = buttonHTML + dropdownHTML;
                  lista.appendChild(li);
                  const button = li.querySelector(`#dropdownNavbarLink-${item.MenuId}`);
                  const dropdownMenu = li.querySelector(`#dropdownNavbar-${item.MenuId}`);

                  button.addEventListener('click', () => {
                    dropdownMenu.classList.toggle('hidden');
                  });
                });
              } catch (error) {
                console.error('Error al obtener los datos:', error);
              }
            };

            FetchData();
            const searchUsers = $("#search");
            const searchForm = $("#search-form");
            const dialogSearch = $('#dialog-search')
            const cerrarDialogSearch = $('#cerrar-dialog')
            searchForm?.addEventListener("submit", async (e) => {
              e.preventDefault(); // Evitar el envío de formulario o recarga de la página
              dialogSearch.showModal()

              const searchValue = searchUsers.value.trim(); // Obtener y recortar el valor de búsqueda

              if (!searchValue) {
                alert("Por favor, ingrese un término de búsqueda.");
                return;
              }

              const url = `search?search=${encodeURIComponent(searchValue)}`;

              try {
                // Hacer la solicitud fetch
                const response = await fetch(url);
                if (!response.ok) {
                  throw new Error("Error en la búsqueda");
                }

                const data = await response.json(); // Asumimos que la respuesta es un JSON
                const resultContainer = document.querySelector("#result-list");
                resultContainer.innerHTML = ""; // Limpiar resultados previos

                data.result.users.forEach((colegiado) => {
                  const listItem = document.createElement("li");
                  listItem.classList.add("w-full");
                  listItem.innerHTML = `
                      <div class="max-w-sm w-full rounded-lg overflow-hidden shadow-lg bg-white p-6">
                          <div class="text-lg font-semibold text-gray-700 mb-3">Información del Colegiado</div>
                          <div class="space-y-2">
                              <div>
                                  <strong class="text-gray-500">ID:</strong>
                                  <span class="text-gray-800">${colegiado.Matricula}</span>
                              </div>
                              <div>
                                  <strong class="text-gray-500">Nombre:</strong>
                                  <span class="text-gray-800">${colegiado.Nombres}</span>
                              </div>
                              <div>
                                  <strong class="text-gray-500">Email:</strong>
                                  <span class="text-gray-800">${colegiado.Correo}</span>
                              </div>
                          </div>
                        </div>
      `;
                  resultContainer.appendChild(listItem);
                });
              } catch (error) {
                console.error("Error en la búsqueda:", error);
                alert("Hubo un problema al realizar la búsqueda. Intenta nuevamente.");
              }
            });
            cerrarDialogSearch.addEventListener('click',()=>{
              dialogSearch.close()
            })
          </script>
</body>

</html>